<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stampli Churn Risk Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .risk-badge-Critical { background-color: #dc3545; color: white; }
        .risk-badge-High { background-color: #fd7e14; color: white; }
        .risk-badge-Medium { background-color: #ffc107; color: black; }
        .risk-badge-Low { background-color: #198754; color: white; }
        
        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            margin: 0 auto;
            border: 10px solid #e9ecef;
        }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold text-primary">Churn Risk Analyzer</h1>
                <p class="lead text-muted">AI-powered analysis of Gong call transcripts</p>
            </div>

            <!-- Search Form -->
            <div class="card shadow-sm mb-5">
                <div class="card-body p-4">
                    <form action="/analyze" method="post" class="d-flex gap-2">
                        <input type="text" name="company_name" class="form-control form-control-lg" 
                               placeholder="Enter Company Name (e.g. Vivo Infusion)" 
                               value="{{ company_name if company_name else '' }}" required>
                        <button type="submit" class="btn btn-primary btn-lg px-4">Analyze</button>
                    </form>
                </div>
            </div>

            <!-- Loading State (managed by simple script) -->
            <div id="loading" class="text-center d-none my-5">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Analyzing transcripts... this may take a minute.</p>
            </div>

            <!-- Error Display -->
            {% if error %}
            <div class="alert alert-danger shadow-sm" role="alert">
                <h4 class="alert-heading">Analysis Failed</h4>
                <p>{{ error }}</p>
            </div>
            {% endif %}

            <!-- Results Display -->
            {% if assessment %}
            <div class="card shadow border-0">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="h4 mb-0">Analysis Result: <span class="text-dark">{{ company_name }}</span></h2>
                        <span class="badge risk-badge-{{ assessment.risk_level }} px-3 py-2 fs-6 rounded-pill">
                            {{ assessment.risk_level }} Risk
                        </span>
                    </div>
                </div>
                <div class="card-body p-4">
                    <!-- Score & Summary -->
                    <div class="row mb-5 align-items-center">
                        <div class="col-md-4 text-center">
                            <div class="score-circle mb-3" style="border-color: 
                                {% if assessment.risk_level == 'Critical' %}#dc3545
                                {% elif assessment.risk_level == 'High' %}#fd7e14
                                {% elif assessment.risk_level == 'Medium' %}#ffc107
                                {% else %}#198754{% endif %};
                                color: {% if assessment.risk_level == 'Critical' %}#dc3545
                                {% elif assessment.risk_level == 'High' %}#fd7e14
                                {% elif assessment.risk_level == 'Medium' %}#d39e00
                                {% else %}#198754{% endif %};">
                                {{ assessment.churn_score }}
                            </div>
                            <h5 class="text-muted">Churn Score</h5>
                        </div>
                        <div class="col-md-8">
                            <h5 class="fw-bold text-dark">Executive Summary</h5>
                            <p class="lead fs-6">{{ assessment.summary }}</p>
                            
                            <div class="mt-3">
                                <strong>Sentiment:</strong> {{ assessment.sentiment_analysis }}
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Red Flags -->
                    <div class="mb-5">
                        <h4 class="mb-3 text-danger"><i class="bi bi-flag-fill me-2"></i>Critical Red Flags</h4>
                        <ul class="list-group list-group-flush">
                            {% for flag in assessment.red_flags %}
                            <li class="list-group-item bg-light border-start border-4 border-danger ps-3 mb-2">
                                {{ flag }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- Risk Signals -->
                    <div class="mb-5">
                        <h4 class="mb-3">Detailed Risk Signals</h4>
                        <div class="row g-3">
                            {% for signal in assessment.signals %}
                            <div class="col-md-6">
                                <div class="card h-100 border-start border-3 
                                    {% if signal.severity == 'Critical' or signal.severity == 'High' %}border-danger
                                    {% elif signal.severity == 'Medium' %}border-warning
                                    {% else %}border-success{% endif %}">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <small class="text-uppercase fw-bold text-muted">{{ signal.category }}</small>
                                            <span class="badge bg-secondary">{{ signal.severity }}</span>
                                        </div>
                                        <p class="card-text">{{ signal.description }}</p>
                                        <small class="text-muted">Impact: +{{ signal.weight_impact }} pts</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div>
                        <h4 class="mb-3 text-success">Recommended Actions</h4>
                        <div class="list-group">
                            {% for rec in assessment.recommendations %}
                            <div class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1 text-dark">{{ rec.action }}</h5>
                                    <small class="fw-bold 
                                        {% if rec.urgency == 'High' %}text-danger
                                        {% elif rec.urgency == 'Medium' %}text-warning
                                        {% else %}text-success{% endif %}">
                                        {{ rec.urgency }} Urgency
                                    </small>
                                </div>
                                <p class="mb-1 text-muted">{{ rec.rationale }}</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                </div>
            </div>
            {% endif %}

            <!-- Raw Response Fallback -->
            {% if raw_response %}
            <div class="card shadow-sm mt-4">
                <div class="card-header">Raw Analysis Result</div>
                <div class="card-body">
                    <pre class="bg-light p-3 rounded"><code>{{ raw_response }}</code></pre>
                </div>
            </div>
            {% endif %}

        </div>
    </div>
</div>

<script>
    document.querySelector('form').addEventListener('submit', function() {
        document.getElementById('loading').classList.remove('d-none');
        // Hide previous results if any
        const resultCard = document.querySelector('.card.shadow');
        if (resultCard) resultCard.style.display = 'none';
        const errorAlert = document.querySelector('.alert-danger');
        if (errorAlert) errorAlert.style.display = 'none';
    });
</script>

</body>
</html>

