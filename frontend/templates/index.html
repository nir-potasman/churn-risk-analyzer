<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stampli Churn Risk Analyzer</title>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Bootstrap 5 & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm py-3">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="/">
            <img src="/static/images/stampli_logo.jpg" alt="Stampli Logo" class="me-3" style="max-height: 40px;">
            <span class="h5 mb-0 fw-bold text-dark border-start ps-3 border-2">Churn Risk Analyzer</span>
        </a>
    </div>
</nav>

<div class="container py-5">
    
    <!-- Header Section -->
    {% if not assessment %}
    <div class="text-center mb-5 animate-fade-in">
        <h1 class="display-5 fw-bold mb-3">Customer Health Intelligence</h1>
        <p class="lead text-muted mx-auto" style="max-width: 600px;">
            Analyze Gong call transcripts to detect churn signals, sentiment, and actionable insights instantly.
        </p>
    </div>
    {% endif %}

    <!-- Search Form -->
    <div class="search-container mb-5 animate-fade-in">
        <div class="card p-2 border-0 shadow-sm">
            <form action="/analyze" method="post" class="d-flex">
                <input type="text" name="company_name" class="form-control search-input border-0 shadow-none bg-transparent" 
                       placeholder="Enter Company Name (e.g. Vivo Infusion)" 
                       value="{{ company_name if company_name else '' }}" required>
                <button type="submit" class="btn btn-analyze text-white shadow-sm">
                    <i class="bi bi-search me-2"></i> Analyze
                </button>
            </form>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center d-none my-5 pt-5">
        <div class="spinner-grow text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 class="fw-normal text-muted">Analyzing conversation signals...</h4>
        <small class="text-muted">Connecting to Manager Agent • Retrieving Transcripts • Applying Scoring Rubric</small>
    </div>

    <!-- Error Display -->
    {% if error %}
    <div class="alert alert-danger shadow-sm border-0 d-flex align-items-center animate-fade-in" role="alert">
        <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
        <div>
            <h5 class="alert-heading mb-1">Analysis Failed</h5>
            <p class="mb-0">{{ error }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Results Display -->
    {% if assessment %}
    <div class="row g-4 animate-fade-in">
        
        <!-- Left Column: Score & Summary -->
        <div class="col-lg-4">
            <!-- Score Card -->
            <div class="card h-100">
                <div class="card-body text-center p-4">
                    <h6 class="text-uppercase text-muted fw-bold mb-4">Risk Assessment</h6>
                    
                    <div class="risk-score-container mb-3">
                        <div class="score-circle" style="border-color: 
                            {% if assessment.risk_level == 'Critical' %}#EF4444
                            {% elif assessment.risk_level == 'High' %}#F97316
                            {% elif assessment.risk_level == 'Medium' %}#F59E0B
                            {% else %}#10B981{% endif %};
                            color: {% if assessment.risk_level == 'Critical' %}#EF4444
                            {% elif assessment.risk_level == 'High' %}#EA580C
                            {% elif assessment.risk_level == 'Medium' %}#D97706
                            {% else %}#059669{% endif %};">
                            {{ assessment.churn_score }}
                            <span class="score-label">Score</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <span class="badge rounded-pill risk-badge-{{ assessment.risk_level }} fs-6 px-4 py-2">
                            {{ assessment.risk_level }} Risk
                        </span>
                    </div>

                    <div class="border-top pt-3 mt-4 text-start">
                        <small class="text-uppercase fw-bold text-muted mb-2 d-block">Sentiment Analysis</small>
                        <p class="mb-0 text-dark">{{ assessment.sentiment_analysis }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Summary & Details -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Executive Summary</h5>
                    <span class="text-muted small"><i class="bi bi-building me-1"></i> {{ company_name }}</span>
                </div>
                <div class="card-body p-4">
                    <p class="lead fs-6 text-secondary">{{ assessment.summary }}</p>
                    
                    <div class="mt-4">
                        <h6 class="text-danger mb-3 fw-bold"><i class="bi bi-flag-fill me-2"></i>Critical Red Flags</h6>
                        <div class="row g-2">
                            {% for flag in assessment.red_flags %}
                            <div class="col-12">
                                <div class="bg-light p-2 rounded border-start border-3 border-danger d-flex align-items-start">
                                    <i class="bi bi-exclamation-circle text-danger mt-1 me-2"></i>
                                    <span>{{ flag }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Signals Section -->
        <div class="col-12">
            <h5 class="mb-3 fw-bold text-dark ps-1">Detected Risk Signals</h5>
            <div class="row g-3">
                {% for signal in assessment.signals %}
                <div class="col-md-6 col-lg-4">
                    <div class="card signal-card signal-{{ signal.severity }} shadow-sm h-100">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between mb-2">
                                <small class="text-uppercase fw-bold text-muted" style="font-size: 0.75rem;">{{ signal.category }}</small>
                                <span class="badge 
                                    {% if signal.severity == 'Critical' or signal.severity == 'High' %}bg-danger
                                    {% elif signal.severity == 'Medium' %}bg-warning text-dark
                                    {% else %}bg-success{% endif %} bg-opacity-10 text-dark border">
                                    {{ signal.severity }}
                                </span>
                            </div>
                            <p class="card-text small mb-2 text-dark fw-medium">{{ signal.description }}</p>
                            <div class="text-end signal-impact 
                                {% if signal.weight_impact > 15 %}impact-high
                                {% elif signal.weight_impact > 5 %}impact-med
                                {% else %}impact-low{% endif %}">
                                {% if signal.weight_impact > 0 %}+{% endif %}{{ signal.weight_impact }} pts
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Recommendations Section -->
        <div class="col-12 mb-5">
            <h5 class="mb-3 fw-bold text-dark ps-1 mt-4">Recommended Actions</h5>
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for rec in assessment.recommendations %}
                        <div class="list-group-item p-4 rec-item rec-urgency-{{ rec.urgency }}">
                            <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                                <h6 class="mb-0 fw-bold text-dark">{{ rec.action }}</h6>
                                <span class="badge rounded-pill 
                                    {% if rec.urgency == 'High' %}bg-danger
                                    {% elif rec.urgency == 'Medium' %}bg-warning text-dark
                                    {% else %}bg-success{% endif %}">
                                    {{ rec.urgency }} Priority
                                </span>
                            </div>
                            <p class="mb-0 text-secondary small">{{ rec.rationale }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

    </div>
    {% endif %}

    <!-- Raw Response Fallback -->
    {% if raw_response %}
    <div class="card shadow-sm mt-4 animate-fade-in border-warning">
        <div class="card-header bg-warning bg-opacity-10 text-warning-emphasis fw-bold">
            <i class="bi bi-code-square me-2"></i>Raw Analysis Output (JSON Parse Failed)
        </div>
        <div class="card-body bg-light">
            <pre class="p-3 mb-0" style="white-space: pre-wrap; font-size: 0.85rem;"><code>{{ raw_response }}</code></pre>
        </div>
    </div>
    {% endif %}

</div>

<script>
    document.querySelector('form').addEventListener('submit', function() {
        document.getElementById('loading').classList.remove('d-none');
        // Hide previous results nicely
        const results = document.querySelectorAll('.animate-fade-in');
        results.forEach(el => el.style.display = 'none');
    });
</script>

</body>
</html>
