services:
  manager-service:
    build:
      context: .
      dockerfile: services/manager/Dockerfile
    command: uv run uvicorn agents.apps.manager_app:app --host 0.0.0.0 --port 8080 --workers 10
    ports:
      - "8080:8080"
    env_file: .env
    environment:
      - TRANSCRIPT_AGENT_URL=http://transcript-service:8001
      - CHURN_AGENT_URL=http://churn-service:8002
    depends_on:
      - transcript-service
      - churn-service

  transcript-service:
    build:
      context: .
      dockerfile: services/transcript/Dockerfile
    command: uv run uvicorn agents.apps.transcript_app:app --host 0.0.0.0 --port 8001 --workers 6
    ports:
      - "8001:8001"
    env_file: .env

  churn-service:
    build:
      context: .
      dockerfile: services/churn/Dockerfile
    command: uv run uvicorn agents.apps.churn_app:app --host 0.0.0.0 --port 8002 --workers 8
    ports:
      - "8002:8002"
    env_file: .env

  frontend-service:
    build:
      context: .
      dockerfile: services/frontend/Dockerfile
    ports:
      - "3000:3000"
    env_file: .env
    environment:
      - MANAGER_SERVICE_URL=http://manager-service:8080
    depends_on:
      - manager-service

  n8n:
    image: docker.n8n.io/n8nio/n8n
    ports:
      - "5678:5678"
    environment:
      - GENERIC_TIMEZONE=Asia/Jerusalem
      - TZ=Asia/Jerusalem
      - EXECUTIONS_TIMEOUT=3600
      - EXECUTIONS_TIMEOUT_MAX=7200
      - N8N_DEFAULT_TIMEOUT=3600
      - CODE_ENABLE_STDOUT=true
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      - manager-service

volumes:
  n8n_data:
    external: true
